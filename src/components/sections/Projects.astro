---
import Section from "../Section.astro";
import { projects } from "@cv";
import type { ImageMetadata } from "astro";

// Cargamos todas las imágenes con metadata
const images = import.meta.glob("../../assets/projects/*", {
  eager: true,
  import: "default"
}) as Record<string, ImageMetadata>;

// Mapeamos filename → metadata
const imageMap: Record<string, ImageMetadata> = {};

for (const [path, data] of Object.entries(images)) {
  const filename = path.split("/").pop();
  if (filename) imageMap[filename] = data;
}

const getImage = (filename: string) => {
  return imageMap[filename]?.src ?? null;
};

// Mapa de colores para tech badges
const techColors: Record<string, string> = {
  react: 'bg-[#61dafb]/20 text-[#61dafb] border-[#61dafb]/30',
  nodejs: 'bg-[#68a063]/20 text-[#68a063] border-[#68a063]/30',
  postgresql: 'bg-[#336791]/20 text-[#336791] border-[#336791]/30',
  tailwind: 'bg-[#06b6d4]/20 text-[#06b6d4] border-[#06b6d4]/30',
  javascript: 'bg-[#f7df1e]/20 text-[#f7df1e] border-[#f7df1e]/30',
  typescript: 'bg-[#3178c6]/20 text-[#3178c6] border-[#3178c6]/30',
  monorepo: 'bg-[#9333ea]/20 text-[#9333ea] border-[#9333ea]/30',
  playwright: 'bg-[#2ecc71]/20 text-[#2ecc71] border-[#2ecc71]/30',
  vercel: 'bg-white/20 text-white border-white/30',
  render: 'bg-[#46e3b7]/20 text-[#46e3b7] border-[#46e3b7]/30',
  default: 'bg-gray-500/20 text-gray-300 border-gray-500/30'
};

const getTechColor = (tech: string) => {
  return techColors[tech.toLowerCase()] || techColors.default;
};
---

<Section title="Proyectos" id="projects">
  <ul class="projects-grid">
    {projects.map((project, idx) => {
      const src = getImage(project.image);
      const repositoryUrl = project['repository-url'];
      const apiUrl = project['api-url'];

      return (
        <li
          class="project-card"
          data-animate="up"
          data-animate-delay={idx * 100}
        >
          <!-- Imagen de fondo -->
          <div class="project-image-wrapper">
            {src ? (
              <img
                src={src}
                alt={project.name}
                class="project-image"
                loading="lazy"
              />
            ) : (
              <div class="project-no-image">
                <span>Sin imagen</span>
              </div>
            )}
          </div>

          <!-- Overlay con gradiente -->
          <div class="project-overlay">
            <div class="project-content">
              <!-- Título -->
              <h3 class="project-title">{project.name}</h3>

              <!-- Descripción -->
              <p class="project-description">{project.description}</p>

              <!-- Tech badges -->
              {project.highlights && project.highlights.length > 0 && (
                <div class="project-tech-badges">
                  {project.highlights.slice(0, 6).map((tech) => (
                    <span class={`tech-badge ${getTechColor(tech)}`}>
                      {tech}
                    </span>
                  ))}
                  {project.highlights.length > 6 && (
                    <span class="tech-badge bg-gray-700/50 text-gray-300 border-gray-600/50">
                      +{project.highlights.length - 6}
                    </span>
                  )}
                </div>
              )}

              <!-- Botones de acción -->
              <div class="project-actions">
                <a
                  href={project.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="project-btn btn-primary"
                >
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M14 8.5V14.5H2V2.5H8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M10 2H14M14 2V6M14 2L7 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span>Demo</span>
                </a>

                {repositoryUrl && (
                  <a
                    href={repositoryUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="project-btn btn-secondary"
                  >
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                      <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    <span>Código</span>
                  </a>
                )}

                {apiUrl && (
                  <a
                    href={apiUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="project-btn btn-secondary"
                    title="API Endpoint"
                  >
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M2 5L8 2L14 5M2 5L8 8M2 5V11L8 14M14 5L8 8M14 5V11L8 14M8 8V14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>API</span>
                  </a>
                )}
              </div>
            </div>
          </div>
        </li>
      );
    })}
  </ul>
</Section>

<style>
  .projects-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  @media (min-width: 768px) {
    .projects-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .projects-grid {
      gap: 2.5rem;
    }
  }

  /* Project Card */
  .project-card {
    position: relative;
    border-radius: var(--radius-xl);
    overflow: hidden;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-md);
    transition: all var(--transition-base);
    height: 400px;
    list-style: none;
  }

  .project-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-2xl);
    border-color: var(--color-primary-300);
  }

  .dark .project-card:hover {
    border-color: var(--color-primary-700);
  }

  /* Imagen */
  .project-image-wrapper {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  .project-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .project-card:hover .project-image {
    transform: scale(1.1);
  }

  .project-no-image {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-neutral-200);
    color: var(--color-neutral-500);
  }

  .dark .project-no-image {
    background: var(--color-neutral-800);
    color: var(--color-neutral-400);
  }

  /* Overlay */
  .project-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.95) 0%,
      rgba(0, 0, 0, 0.8) 40%,
      rgba(0, 0, 0, 0.4) 70%,
      transparent 100%
    );
    opacity: 0.9;
    transition: opacity var(--transition-base);
    z-index: 1;
  }

  .project-card:hover .project-overlay {
    opacity: 1;
  }

  /* Contenido */
  .project-content {
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 1.5rem;
    z-index: 2;
  }

  @media (min-width: 640px) {
    .project-content {
      padding: 2rem;
    }
  }

  /* Título */
  .project-title {
    font-size: 1.5rem;
    font-weight: var(--font-weight-bold);
    color: white;
    margin: 0 0 0.75rem 0;
    line-height: 1.2;
  }

  @media (min-width: 640px) {
    .project-title {
      font-size: 1.75rem;
    }
  }

  /* Descripción */
  .project-description {
    font-size: 0.875rem;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.9);
    margin: 0 0 1rem 0;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media (min-width: 640px) {
    .project-description {
      font-size: 0.9375rem;
    }
  }

  /* Tech Badges */
  .project-tech-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
  }

  .tech-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: var(--font-weight-semibold);
    border: 1px solid;
    backdrop-filter: blur(8px);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  /* Botones de acción */
  .project-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .project-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: var(--font-weight-semibold);
    text-decoration: none;
    transition: all var(--transition-base);
    border: 1px solid transparent;
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--color-primary-600), var(--color-primary-700));
    color: white;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.5);
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-color: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(8px);
  }

  .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }

  /* Responsive para móviles */
  @media (max-width: 640px) {
    .project-card {
      height: 450px;
    }

    .project-actions {
      flex-direction: column;
      width: 100%;
    }

    .project-btn {
      width: 100%;
      justify-content: center;
    }

    .project-tech-badges {
      gap: 0.375rem;
    }

    .tech-badge {
      font-size: 0.6875rem;
      padding: 0.1875rem 0.625rem;
    }
  }
</style>